{"filter":false,"title":"test.py","tooltip":"/test.py","undoManager":{"mark":30,"position":30,"stack":[[{"start":{"row":0,"column":0},"end":{"row":7,"column":51},"action":"insert","lines":["import os","","import cv2","from PIL import Image","import numpy as np","","import paddle","from paddle.utils.download import get_path_from_url"],"id":1}],[{"start":{"row":2,"column":0},"end":{"row":7,"column":51},"action":"remove","lines":["import cv2","from PIL import Image","import numpy as np","","import paddle","from paddle.utils.download import get_path_from_url"],"id":4}],[{"start":{"row":2,"column":0},"end":{"row":7,"column":51},"action":"insert","lines":["import cv2","from PIL import Image","import numpy as np","","import paddle","from paddle.utils.download import get_path_from_url"],"id":5}],[{"start":{"row":7,"column":51},"end":{"row":8,"column":0},"action":"insert","lines":["",""],"id":7},{"start":{"row":8,"column":0},"end":{"row":9,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":9,"column":0},"end":{"row":11,"column":60},"action":"insert","lines":["from ppgan.faceutils.dlibutils import align_crop","from ppgan.faceutils.face_segmentation import FaceSeg","from ppgan.models.generators import ResnetUGATITP2CGenerator"],"id":8}],[{"start":{"row":10,"column":5},"end":{"row":10,"column":10},"action":"remove","lines":["ppgan"],"id":9},{"start":{"row":10,"column":5},"end":{"row":10,"column":6},"action":"remove","lines":["."]}],[{"start":{"row":11,"column":5},"end":{"row":11,"column":10},"action":"remove","lines":["ppgan"],"id":10},{"start":{"row":11,"column":5},"end":{"row":11,"column":6},"action":"remove","lines":["."]}],[{"start":{"row":9,"column":5},"end":{"row":9,"column":11},"action":"remove","lines":["ppgan."],"id":11}],[{"start":{"row":11,"column":54},"end":{"row":12,"column":0},"action":"insert","lines":["",""],"id":12},{"start":{"row":12,"column":0},"end":{"row":13,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":13,"column":0},"end":{"row":60,"column":22},"action":"insert","lines":["P2C_WEIGHT_URL = \"https://paddlegan.bj.bcebos.com/models/photo2cartoon_genA2B_weight.pdparams\"","","","class Photo2CartoonPredictor(BasePredictor):","    def __init__(self, output_path='output', weight_path=None):","        self.output_path = output_path","        if not os.path.exists(self.output_path):","            os.makedirs(self.output_path)","","        if weight_path is None:","            cur_path = os.path.abspath(os.path.dirname(__file__))","            weight_path = get_path_from_url(P2C_WEIGHT_URL, cur_path)","","        self.genA2B = ResnetUGATITP2CGenerator()","        params = paddle.load(weight_path)","        self.genA2B.set_state_dict(params)","        self.genA2B.eval()","","        self.faceseg = FaceSeg()","","    def run(self, image_path):","        image = Image.open(image_path)","        face_image = align_crop(image)","        face_mask = self.faceseg(face_image)","","        face_image = cv2.resize(face_image, (256, 256), interpolation=cv2.INTER_AREA)","        face_mask = cv2.resize(face_mask, (256, 256))[:, :, np.newaxis] / 255.","        face = (face_image * face_mask + (1 - face_mask) * 255) / 127.5 - 1","","        face = np.transpose(face[np.newaxis, :, :, :], (0, 3, 1, 2)).astype(np.float32)","        face = paddle.to_tensor(face)","","        # inference","        with paddle.no_grad():","            cartoon = self.genA2B(face)[0][0]","","        # post-process","        cartoon = np.transpose(cartoon.numpy(), (1, 2, 0))","        cartoon = (cartoon + 1) * 127.5","        cartoon = (cartoon * face_mask + (1 - face_mask) * 255).astype(np.uint8)","","        pnoto_save_path = os.path.join(self.output_path, 'p2c_photo.png')","        cv2.imwrite(pnoto_save_path, cv2.cvtColor(face_image, cv2.COLOR_RGB2BGR))","        cartoon_save_path = os.path.join(self.output_path, 'p2c_cartoon.png')","        cv2.imwrite(cartoon_save_path, cv2.cvtColor(cartoon, cv2.COLOR_RGB2BGR))","","        print(\"Cartoon image has been saved at '{}'.\".format(cartoon_save_path))","        return cartoon"],"id":13}],[{"start":{"row":16,"column":29},"end":{"row":16,"column":42},"action":"remove","lines":["BasePredictor"],"id":14}],[{"start":{"row":60,"column":22},"end":{"row":61,"column":0},"action":"insert","lines":["",""],"id":15},{"start":{"row":61,"column":0},"end":{"row":61,"column":8},"action":"insert","lines":["        "]},{"start":{"row":61,"column":8},"end":{"row":62,"column":0},"action":"insert","lines":["",""]},{"start":{"row":62,"column":0},"end":{"row":62,"column":8},"action":"insert","lines":["        "]},{"start":{"row":62,"column":8},"end":{"row":63,"column":0},"action":"insert","lines":["",""]},{"start":{"row":63,"column":0},"end":{"row":63,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":63,"column":4},"end":{"row":63,"column":8},"action":"remove","lines":["    "],"id":16}],[{"start":{"row":63,"column":4},"end":{"row":63,"column":31},"action":"insert","lines":["if __name__ == '__main__': "],"id":17}],[{"start":{"row":63,"column":31},"end":{"row":64,"column":0},"action":"insert","lines":["",""],"id":18},{"start":{"row":64,"column":0},"end":{"row":64,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":64,"column":8},"end":{"row":66,"column":0},"action":"insert","lines":["p2c = Photo2CartoonPredictor()","p2c.run('test_img.jpg')",""],"id":19}],[{"start":{"row":65,"column":0},"end":{"row":65,"column":4},"action":"insert","lines":["    "],"id":20}],[{"start":{"row":65,"column":4},"end":{"row":65,"column":8},"action":"insert","lines":["    "],"id":21}],[{"start":{"row":65,"column":17},"end":{"row":65,"column":29},"action":"remove","lines":["test_img.jpg"],"id":22},{"start":{"row":65,"column":17},"end":{"row":65,"column":82},"action":"insert","lines":["https://aqrcode.s3.ap-southeast-1.amazonaws.com/public/images.jpg"]}],[{"start":{"row":64,"column":37},"end":{"row":64,"column":38},"action":"remove","lines":[")"],"id":23},{"start":{"row":64,"column":36},"end":{"row":64,"column":37},"action":"remove","lines":["("]}],[{"start":{"row":16,"column":29},"end":{"row":16,"column":30},"action":"remove","lines":[")"],"id":24},{"start":{"row":16,"column":28},"end":{"row":16,"column":29},"action":"remove","lines":["("]}],[{"start":{"row":64,"column":36},"end":{"row":64,"column":38},"action":"insert","lines":["()"],"id":25}],[{"start":{"row":63,"column":31},"end":{"row":64,"column":0},"action":"insert","lines":["",""],"id":27},{"start":{"row":64,"column":0},"end":{"row":64,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":64,"column":8},"end":{"row":64,"column":30},"action":"insert","lines":["Photo2CartoonPredictor"],"id":28}],[{"start":{"row":64,"column":8},"end":{"row":64,"column":9},"action":"insert","lines":["i"],"id":29},{"start":{"row":64,"column":9},"end":{"row":64,"column":10},"action":"insert","lines":["m"]},{"start":{"row":64,"column":10},"end":{"row":64,"column":11},"action":"insert","lines":["p"]},{"start":{"row":64,"column":11},"end":{"row":64,"column":12},"action":"insert","lines":["o"]},{"start":{"row":64,"column":12},"end":{"row":64,"column":13},"action":"insert","lines":["r"]},{"start":{"row":64,"column":13},"end":{"row":64,"column":14},"action":"insert","lines":["t"]}],[{"start":{"row":64,"column":14},"end":{"row":64,"column":15},"action":"insert","lines":[" "],"id":30}],[{"start":{"row":63,"column":31},"end":{"row":64,"column":37},"action":"remove","lines":["","        import Photo2CartoonPredictor"],"id":31}],[{"start":{"row":63,"column":0},"end":{"row":63,"column":4},"action":"remove","lines":["    "],"id":32}],[{"start":{"row":64,"column":0},"end":{"row":64,"column":4},"action":"remove","lines":["    "],"id":33},{"start":{"row":65,"column":0},"end":{"row":65,"column":4},"action":"remove","lines":["    "]}],[{"start":{"row":65,"column":13},"end":{"row":65,"column":68},"action":"remove","lines":["https://aqrcode.s3.ap-southeast-1.amazonaws.com/public/"],"id":34}],[{"start":{"row":65,"column":13},"end":{"row":65,"column":19},"action":"remove","lines":["images"],"id":35},{"start":{"row":65,"column":13},"end":{"row":65,"column":25},"action":"insert","lines":["613075_v9_bb"]}]]},"ace":{"folds":[],"scrolltop":719,"scrollleft":0,"selection":{"start":{"row":65,"column":25},"end":{"row":65,"column":25},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":50,"state":"start","mode":"ace/mode/python"}},"timestamp":1705480298999,"hash":"9e0764060da0bcf359806f960e3d7747bf8abea7"}